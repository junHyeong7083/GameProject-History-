using System.Collections;
using System.Collections.Generic;
using Unity.VisualScripting;
using UnityEngine;
using UnityEngine.UI;

public class PlayerController : MonoBehaviour
{
    //-------------------기본설정-------------------
    [Header("PlayerSet")]
    public GameObject Player;
    public GameObject Line;
    public float speed;
    public Text debugTest;
    //-------------------이동관련-------------------
    [Header("TouchMoved")]
    Touch touch1; // 이동 터치
    Touch touch2; // 공격 터치
    Vector2 dir; // 이동에 적용될 벡터

    //-------------------공격관련-------------------
    [Header("TouchAtk")]
    public LineRenderer lineRenderer;
    public float lineDrawSpeed;
    Vector3 AtkRange; //

    //-------------------사용할 컴포넌트-------------------
    EdgeCollider2D lineCollider; // 라인렌더러시 사용할 콜라이더
    Rigidbody2D lineRigid;


    //---------------------bool--------------------------
    bool isAtk = false; // 공격중일때는 움직임x
    bool isRender = false;
    bool isMoving = false;
    bool isRay = false;
    //---------------------Els--------------------------
    public Image TestImage;
    void Start()
    {
        lineCollider = Line.GetComponent<EdgeCollider2D>();
        lineRigid = Line.GetComponent<Rigidbody2D>();
    }

    void Update()
    {
        if (Input.touchCount > 0) // 첫 입력
        {
            touch1 = FindTouchById(0);
            if (FindTouchById(0).phase == TouchPhase.Moved || FindTouchById(0).phase == TouchPhase.Began)
            {
                if (!isAtk)
                {

                    dir = (touch1.position - touch1.rawPosition).normalized / 3;
                    // dirtxt.text = "x : " + dir.x + "y : " + dir.y; 테스트
                    isMoving = true;
                    Player.transform.Translate(dir * speed * Time.deltaTime);
                }
            }

            if (Input.touchCount >= 1) // 2번째 입력
            {
                touch2 = FindTouchById(1);
                if (Input.GetTouch(1).phase == TouchPhase.Moved)
                {
                    isAtk = true;
                    isMoving = false;
                    if (isAtk)
                    {
                        AtkRange = Camera.main.ScreenToWorldPoint(touch2.position);
                        AtkRange.z = 0f;
                        // atktxt.text = "atkx : " + AtkRange.x + "atky : " + AtkRange.y; 테스트

                        Vector3 dir = AtkRange.normalized;

                        isRender = true;
                        if (isRender)
                        {
                            // 중심점 옮기기
                            float r = (Player.transform.localScale.x / 2) + 0.5f; // 반지름뒤 숫자를 수정하면됨
                            Vector3 drag = AtkRange;
                            Vector3 center = Player.transform.position; // 중점

                            float theta = Mathf.Atan2(drag.y - center.y, drag.x - center.x);
                            Vector3 edge = new Vector3(center.x + r * Mathf.Cos(theta), center.y + r * Mathf.Sin(theta));

                            Vector3[] positions = new Vector3[lineRenderer.positionCount];
                            lineRenderer.GetPositions(positions);
                            positions[0] = edge;
                            positions[1] = AtkRange;

                            lineRenderer.enabled = true;
                            lineRenderer.SetPositions(positions);

                            #region RayCast
                            Vector3 rayDir = (AtkRange - edge).normalized;
                            RaycastHit2D hit = Physics2D.Raycast(edge, rayDir);
                            if (hit == GameObject.FindGameObjectWithTag("Boss"))
                            {
                                isRay = true;
                            }
                            else
                                isRay = false;
                            #endregion

                        }
                    }
                }
                else if (FindTouchById(0).phase == TouchPhase.Ended || FindTouchById(1).phase == TouchPhase.Ended) // 손을 뗏을때1
                {
                    isAtk = false;
                    isRay = false;
                    if (isRender) // 그렸던 라인을 지우는 과정
                    {
                        Vector3 touchWorldPosition = Camera.main.ScreenToWorldPoint(touch2.position);
                        Player.transform.position = new Vector2(touchWorldPosition.x, touchWorldPosition.y);
                        isRender = false;
                        lineRenderer.enabled = false;
                        lineRenderer.SetPositions(new Vector3[0]);

                    }
                }

            }

                Touch FindTouchById(int id)
                {
                    for (int i = 0; i < Input.touchCount; ++i)
                    {
                        Touch t = Input.GetTouch(i);
                        if (t.fingerId == id) return t;
                    }

                    return default(Touch);
                } // 터치 순서따라 finger id값 저장
            }

        if(isRay) // 몬스터가 피격중일때
        {
            TestImage.color = Color.red;
        }
        if(!isRay) // 테스트용 나중에 지우기
        {
            TestImage.color = Color.white;
        }
    }
 
}

